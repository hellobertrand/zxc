name: Publish Rust Crates

on:
  workflow_dispatch:
  release:
    types: [ published ]

permissions:
  contents: read

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
          - os: macos-latest
            arch: x86_64 arm64
          - os: windows-latest
            arch: AMD64
          - os: windows-11-arm
            arch: ARM64
    defaults:
      run:
        working-directory: ./wrappers/rust

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Install Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Run Tests
        run: cargo test --workspace

  publish:
    name: Publish to crates.io
    needs: [test]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    defaults:
      run:
        working-directory: ./wrappers/rust

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Install Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Verify Version Matches Release Tag
        run: |
          RELEASE_VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          RELEASE_VERSION="${RELEASE_VERSION#v}"
          
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          
          if [ "$RELEASE_VERSION" != "$CARGO_VERSION" ]; then
            echo "Version mismatch: Release tag is $RELEASE_VERSION but Cargo.toml has $CARGO_VERSION"
            exit 1
          fi
          
          echo "Version matches: $RELEASE_VERSION"

      - name: Publish zxc-compress-sys (FFI bindings)
        run: |
          cd zxc-sys
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      # Wait for zxc-compress-sys to be available on crates.io before publishing zxc-compress
      - name: Wait for zxc-compress-sys to propagate
        run: sleep 30

      - name: Publish zxc-compress (safe wrapper)
        run: |
          cd zxc
          cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: false

      - name: Summary
        if: success()
        run: |
          echo "Successfully published:"
          echo "- zxc-compress-sys (FFI bindings)"
          echo "- zxc-compress (safe wrapper)"
          echo ""
          echo "Crates are now available on crates.io!"
